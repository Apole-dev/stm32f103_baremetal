name: Bare-Metal CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "**" ]

jobs:
  code-quality:
    name: "Code Quality Check"
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Install Clang Tools
      run: sudo apt-get update && sudo apt-get install -y clang-format clang-tidy

    - name: Run clang-format check
      continue-on-error: true
      run: |
        clang-format --dry-run -Werror \
        $(find app bsp drivers mcal -name "*.c" -or -name "*.h")

    - name: Run clang-tidy check
      continue-on-error: true
      run: |
        clang-tidy \
          $(find drivers/inc drivers/src mcal/stm32f1xx/inc mcal/stm32f1xx/src -name "*.c") \
          -- \
          -Idrivers/inc \
          -Idrivers/src \
          -Imcal/stm32f1xx/inc \
          -Imcal/stm32f1xx/src \
          -DSTM32F103xB

  build:
    name: Build with Docker
    needs: code-quality
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Build Docker image
      run: |
        docker build \
          --build-arg HOST_UID=1000 \
          --build-arg HOST_GID=1000 \
          --build-arg USER_NAME=runner \
          -t stm32f103-arm-baremetal .

    - name: Run make inside container
      run: |
        docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            stm32f103-arm-baremetal ls -la
      
